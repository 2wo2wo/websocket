<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>chatRoom</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
{% load static %}
  <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Lato'><link rel="stylesheet" href="{% static 'css/contacts.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
<!-- partial:index.partial.html -->
<div class="--dark-theme" id="chat">
  <div class="chat__conversation-board" id="chat_board">

    {% for message in  messages %}
      {% if message.owner_id.id == user_id %}
        {% include 'chat/user.html' %}
      {% else %}
        {% include 'chat/sender.html' %}
      {% endif %}
    {% endfor %}

  </div>
  <div class="chat__conversation-panel">
    <div class="chat__conversation-panel__container">
      <button class="chat__conversation-panel__button panel-item btn-icon add-file-button">
        <svg class="feather feather-plus sc-dnqmqq jxshSx" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
      <button class="chat__conversation-panel__button panel-item btn-icon emoji-button">
        <svg class="feather feather-smile sc-dnqmqq jxshSx" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
          <line x1="9" y1="9" x2="9.01" y2="9"></line>
          <line x1="15" y1="9" x2="15.01" y2="9"></line>
        </svg>
      </button>      
      <input class="chat__conversation-panel__input panel-item" id="chat-message-input" placeholder="Type a message..."/>      
      <button class="chat__conversation-panel__button panel-item btn-icon send-message-button" id="chat-message-submit">
         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" data-reactid="1036">
          
          <line x1="22" y1="2" x2="11" y2="13"></line>
          <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
      </button>
    </div>
  </div>
</div>
{{ room_name|json_script:"room-name" }}
{{ user_id|json_script:"user_id" }}
<!--<script src="{% static 'js/index.js' %}"></script>-->
<script>
  const roomName = JSON.parse(document.getElementById('room-name').textContent);
const userId = JSON.parse(document.getElementById('user_id').textContent);
const element = document.getElementById('chat_board');
element.scrollTop = element.scrollHeight;


  const chatSocket = new WebSocket(
      'wss://' + window.location.host
      + '/ws/chat/'
      + roomName
      + '/'
  );

  chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      elMessage(data);
      element.scrollTop = element.scrollHeight;

  };

  chatSocket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };

  document.querySelector('#chat-message-input').focus();
  document.querySelector('#chat-message-input').onkeyup = function(e) {
      if (e.keyCode === 13) {  // enter, return
          document.querySelector('#chat-message-submit').click();
      }
  };

  function createSender(data) {
    const top = document.createElement('div')
    top.classList.add('chat__conversation-board__message-container')
    if (data.user_id === userId ){
        top.classList.add('reversed')
    }
    const child = document.createElement('div')
    child.classList.add("chat__conversation-board__message__context")
    const child_of_child = document.createElement('div')
    child_of_child.classList.add('chat__conversation-board__message__bubble')
    const textMessage = document.createElement('span')
    textMessage.textContent = data.message
    child_of_child.appendChild(textMessage)
    child.appendChild(child_of_child)
    top.appendChild(child)
    return top
  }

  function elMessage(data){
      let a = document.getElementById('chat_board');
      const fragment = document.createDocumentFragment();
      const li = fragment
      .appendChild(createSender(data));
      a.appendChild(fragment)
  }

  document.querySelector('#chat-message-submit').onclick = function(e) {
      const messageInputDom = document.querySelector('#chat-message-input');
      const message = messageInputDom.value;

      chatSocket.send(JSON.stringify({
          'user_id':userId,
          'message': message
      }));

      messageInputDom.value = '';
  };

</script>
</body>
</html>
